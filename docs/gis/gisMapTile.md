# GIS地图切片/瓦片
## 定义
经过Web墨卡托投影后，地图就变为平面的一张地图。考虑到有时候我们需要看宏观的地图信息（如世界地图里每个国家的国界），有时候又要看很微观的地图信息（如导航时道路的路况信息）。为此，我们对这张地图进行等级切分。
在最高级（即_zoom=0_），需要的信息最少，只需保留最重要的宏观信息，因此用一张 _256x256_ 像素的图片表示即可；在下一级（即_zoom=1_），信息量变多，用一张 _512x512_ 像素的图片表示；以此类推，级别越低的像素越高，下一级的像素是当前级的 _4_ 倍。这样从最高层级往下到最低层级就形成了一个金字塔坐标体系。
![][image-1]
----
对每张图片，我们将其切分为 _256x256_ 的图片，称为**瓦片（Tile）**
在最高级（即_zoom=0_）时，只有_1_个瓦片；在下一级（即_zoom=1_）时有_4_个瓦片；在下一级（即_zoom=2_）时有_16_个瓦片。
以此可得，**瓦片数量与层级的关系：**
** 瓦片数量 = 2^(层级 \* 2)**
 ![][image-2]
----

||瓦片（tile）数据是将矢量或者影像数据进行预处理，采用高效的缓存机制（如金字塔）形成的缓存图片集，采用“级、行、列”方式进行阻止，可在网页中快速加载。因此，瓦片地图加载是根据客户端请求的地图范围和级别，通过计算行列号获取对应急别吓网格的瓦片（即服务器预裁剪的图片），由这些瓦片集在客户端形成一张地图。

## 重要概念
![][image-3]
----
1. 切片原点（Tile scheme origin）
采用源数据集空间参考的坐标值，一般切片方案原点取左上角（例如：谷歌切片方案的原点是[\[-20037508.34,20037508.34]]()），但有些切片方案原点却在左下角（例如：TMS切片方案原点是[\[-20037508.34,-20037508.34]]()）。
源数据集的范围必须在此原点范围内。
----
2. 切片范围
切片范围并非地图范围，是切片方案下做切片的范围。例如谷歌的切片范围是[\[-20037508.34,-20037508.34,20037508.34,20037508.34]]()
----
3. 切片大小（Tile Size: width, height）
缓存切片的宽度和高度（以像素_px_为单位）。默认值为 _256x256_。为考虑地图性能和可管理性，应采用 _256_ 或 _512_ 作为宽度值。
----
4. DPI
屏幕分辨率，专用输出设备的每英寸点数_（1英寸 = 0.0254米）_。如果所选DPI与显示器的分辨率不匹配，切片显示会显示错误比例。默认值为 _96_ 。
----
5. 地面分辨率（Ground Resolution）
一个像素（px）等于实际多少米（meter），叫做地面分辨率。
若已知_纬度坐标_，可用**公式1（单位米/像素）：**
**地面分辨率 = 2 \* π \* cos(latitude \* π / 180) \* 6378137 / (256 \* 2^level)**
- 缩放级别（level）：决定像素多少
- 纬度坐标（latitude）：决定地面距离的长短
- 赤道半径：6378137
若已知_纬向范围_，可用**公式2：**
**地面分辨率 = range / (256 \* 2^level)**
- 纬向范围（range）
- 缩放级别（level）
----
6. 地图比例尺（Map Scale）
地图上的距离跟实际距离的比例，叫做地图比例尺。
**公式：**
**比例尺 = 地面分辨率 \* DPI / 0.0254**
----
所以分辨率和比例尺，知其一便可知其二。
在不同坐标系下（以 DPI = 96 为例），赤道的各级分辨率如下：
**EPSG:3857(Pseudo-Mercator)坐标**
按照3857坐标下的切片规则，在该坐标系下，地理范围为 [\[-20037508.34，-20037508.34，20037508.34，20037508.34]]() ，生成的切片大小为 _256_
**计算公式：**
**Resolution = (20037508.34 - (-20037508.34)) / (256 \* 2^level)**
![][image-4]
**EPSG:4326 (WGS84)坐标**
按照4326坐标下的切片规则，在该坐标系下，地理范围为 [\[-180, -90,180,90]]()，生成的切片大小为 _256_
**计算公式：**
**Resolution = (90 - (-90)) / (256 \* 2^level)**
![][image-5]
> _天地图的投影地图、OSM地图、谷歌地图的比例尺与分辨率实际上是相同的_
----
7. 瓦片编号
瓦片生成后，就是一堆图片。怎么对这堆图片进行编号，是目前主流互联网地图商分歧最大的地方。
总结起来可以分为四个流派：
- 谷歌（XYZ）：高德、谷歌地图使用的标准。Z表示缩放层级zoom；XY的原点在左上角，X从左向右，Y从上向下
- TMS（XYZ）：开源产品的标准，腾讯地图使用。Z的定义与谷歌相同；XY的原点在左下角，X从左向右，Y从下往上
- QuadTree：微软Bing地图使用的编码规范。Z的定义与谷歌相同；同一层级的瓦片只用一个整数表示而无需XY两个维度；该整数服从四叉树编码规则
- 百度（XYZ）：Z从1开始，在最高级就把地图分为四块瓦片；XY的原点在经纬度为[\[0,0]][6]的位置；X从左向右，Y从下向上
下图显示的是谷歌、TMS、QuadTree在 zoom=1 时层级上的瓦片编号结果：
![][image-6]
----
||##切片层级计算方式
||1. 起始层数（0）
||- 栅格数据最小经度（xMin）
||- 栅格数据最大经度（xMax）
||**起始层数 = Log(第0层经纬度跨度 / 当前地图的经纬度跨度, 2)**
||所以：
||**minzoom = (int)( Log(360 / (xMax - xMin), 2)**
||以上述_谷歌切片范围_为例，经度范围为[\[-20037508.34,20037508.34]]()，转成wgs84为%%[\[-85.05112877980659, 85.05112877980659]]()，代入可得起始层数只有1个切片。

## 切片的分类
GIS的地图一直使用金字塔技术进行切图，使用户能够快速访问指定级别的地图或者影像。但是切片本身是一张图片，无法进行交互。于是又引入了矢量图层从用来显示矢量点线面（需要先获取矢量地理数据如 _GeoJson_，然后通过前端将其绘制成不同元素），进而实现响应交互。
![][image-7]
![][image-8]
----
### 一、栅格切片
![][image-9]
----
随着大数据技术的发展，人们对电子地图的快速共享需求也愈发强烈。传统电子地图共享时，通常会通过瓦片裁剪工具获取栅格瓦片。相对于其他技术，栅格瓦片底图有不少优点：例如有效减少了传输数据体积、多级缩放、数据结构简单、生产速度快、成本低等。
然而，栅格瓦片底图也有一些比较突出的问题：
- **数据量大**，在存储和管理上需要采用一定的压缩技术；
- **缺乏灵活性**。栅格瓦片完成后，已经保存为图片格式，样式不可修改。若要多种栅格底图，需裁剪多份栅格瓦片底图；
- **缺乏实时性**。由于栅格瓦片已保存为图片格式，当现实世界地物有变化时，不能实时更新，只能重新裁剪栅格瓦片；
- **数据完整性受损**。栅格瓦片没有属性信息，若需要查询图片的多边形属性，需要重新请求。
----
以下是栅格切片常用的发布格式：WMS、TMS、WMTS
----
**WMS（Web Map Service）：网络地图服务**
这个最简单也最基础，就是把数据源，想方设法转化成一张和数据源长得一样的图片。
可供用户浏览。用户可以放大缩小这张图片；但是无论怎么放大缩小，它就只是一张图片。
----
**WMTS（Web Map Tile Service）：网络地图切片服务**
WMTS服务采用缓存技术能够缓解WebGis服务器端数据处理的压力。WMTS 比 WMS 好的地方就是它能够加快加载速度，提升加载效率。
但同时也失去了灵活性，所渲染的每一个区域都是被提前划分好的，限制在固定条带内。
----
**TMS（Tiled Map Service）：瓦片地图服务**
和 WMTS 的主要区别在于，TMS 切片地图是正方形的，而 WMTS 的切片可以是矩形的。另外两者的金字塔横纵坐标也相反。
----
> _WMTS 服务和 WMS 服务都是由开发地理信息联盟（OGC）指定；TMS 服务由开源空间信息基金会（OSGEO）指定_
----
%%**栅格数据**
%%点实体由一个栅格像元来表示；线实体由一定方向上的栅格像元来标识；面实体由具有相同属性的相邻栅格像元的块集合来表示。
%%tif格式是栅格数据，栅格数据就是将空间分割成有规律的网格，每一个网络称为一个像元，每一个像元的位置由它的行列号定义，栅格行列位置表示的实体位置。
%%栅格数据是按照网络单元的行与列排列、不同灰度与色彩的阵列数据。栅格结构是大小相等，分布均匀、紧密相连的像元阵列，用以表示空间地物或现象分布的一种数据组织。每一个单元由它的行列号定义，所表现的实体隐含在栅格行列位置中，数据组织中每个数据表示地物或现象的非几何属性或指向其属性的指针。
----
### 二、矢量切片
![][image-10]
----
鉴于栅格瓦片底图的劣势，矢量瓦片针对矢量电子地图，按照一定的标准和技术将其保存为多种比例尺的矢量分块数据，在前端显示电子地图时，可直接调用矢量分块进行绘制。
- **可保留属性信息**，有地图要素编码、属性、位置、名称及相互之间拓扑关系等方面的信息；
- **可采用分块编码模式**，客户端获取时只返回请求区域和相应级别的矢量瓦片底图，且采用实时绘制矢量模式，绘制效率更高；
- **无级缩放**。矢量瓦片分辨率高达`4096*4096`，是栅格瓦片的16倍，可保证缩放过程中的细节高度还原，且满足高分辨率屏幕绘制需求；
- **数据量小方便使用**，有特定的组织形式和数据结构，较为灵活，可以分层、分类、分级使用，能够快速进行检索查询；
- **具有动态性**，切片内容和渲染样式可以实时修改；
- **自定义渲染样式**。客户端显示矢量瓦片底图时，可以按照用户赋予的样式渲染。如导航地图有白天黑夜两种模式，只需共用一份矢量瓦片底图，利用两套样式进行渲染即可；通过属性过滤条件可以任意过滤筛选图层元素，实行个性化定制；可以编辑底图中每一个矢量图层的可见状态，调整矢量层的叠加层级顺序，修改矢量图层的颜色大小等显示样式。
----
矢量切片常用的发布格式有：**MVT、WFS**
----
**MVT（Mapbox Vector）：Mapbox指定的矢量切片规范**
MVT 是一种高效的二进制格式，是生产环境中首选的矢量切片格式，几乎所有的矢量切片应用程序都支持这种格式
----
**WFS（Web Feature Service）：网络要素服务**
WFS3.0（包括基于 MVT 规范和 GeoJSON 矢量切片（JVT）输出格式的矢量切片）是 MVT 演变而来，优化了在现代机制中提供地理空间数据。
----
%%**矢量数据**
%%矢量数据一般通过记录坐标的方法来尽可能的将地理实体的空间位置表现的准确无误。
%%shp格式是矢量数据，矢量数据是利用几何学中的点、线、面及其组合体来表示地理实体空间分布的一种数据组织方式，矢量数据有属性表。
%%矢量主要是指城市大比例尺地形图。此系统中图层的主要分为底图层、道路图以及单位图，合理的分层便于叠加分析、无缝拼接以实现系统的大范围漫游。矢量数据一般通过记录坐标的方式来尽可能的将地理实体的空间位置表现得准确无误，显示的图形一般为矢量图与位图。


[6]:	]


[image-1]:	# "金字塔"
[image-2]:	# "GIS地图切片"
[image-3]:	# "切片"
[image-4]:	# "EPSG:3857(Pseudo-Mercator)坐标"
[image-5]:	# "EPSG:4326 (WGS84)坐标"
[image-6]:	# "瓦片编号"
[image-7]:	# "栅格和矢量"
[image-8]:	# "栅格化"
[image-9]:	# "栅格地图"
[image-10]:	# "矢量地图"