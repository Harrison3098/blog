# Git工作流

## 一、TrunkBased
> 主干开发：[ Trunk Based Development ]
>
> TrunkBased 是“持续发布”思想所崇尚的工作方式，它由单个主干分支和许多发布分支组成，每个发布分支在特定版本的提交点上从主干创建出来，用来进行上线部署和 Hotfix。在 TrunkBased 模式中，没有显式的功能分支。
>
> 使用主干开发后，我们的代码库原则上就只能有一个 Trunk 分支（即 master 分支），所有新功能的提交也都提交到 master 分支上，保证每次提交后 master 分支都是随时可发布的状态。

**优点：**
- 没有了分支的代码隔离，测试和解决冲突都变得简单，持续集成也变得稳定了许多；
- 对 SVN 迁移过来的团队非常友好；适合小型团队。

**缺点：**
- 当团队规模扩大时共同开发，代码提交合并将会异常痛苦；
- 没有显式的功能分支，难以移除已上线的功能。

## 二、Git Flow
> [ Git Flow ]是最早诞生、并得到广泛采用的一种工作流程
(img)
Git Flow 主要有五大分支，五大分支也可分为长期分支和短期分支。
### 长期分支
>长期存在于项目中的分支
(img)
- 主干分支（master）：用于存放对外发布的版本。这个分支只能从其他分支合并，不能在 master 分支直接修改。
- 主开发分支（develop）：用于日常开发，存放最新的开发版。可以在此分支直接开发，也可以将 Feature 的新功能合并到此分支中。
### 短期分支
>使用完毕后可以删除的分支
- 功能分支（feature）：用于新功能的开发。从 develop 分离，完成后合并入 develop 分支。
(img)
- 预发布分支（release）：发布正式版之前（即合并到 master 分支前），用于预发布测试的分支。从 develop 分离，预发布结束后合并入 develop 和 master 分支。
(img)
- 热修复分支（hotfix）：用于修复bug。从线上版本 master 分离，修复完毕后合并入 develop 和 master 分支。
(img)
**优点**
- 整个项目生命周期内，分支状态十分干净，各个分支各司其职；
- 分支的命名遵循系统的模式，使其更易于理解；
- master 和 develop 分支分别记录发布和功能开发的历史；
- 由于有发布分支，其他暂不发布的功能的开发不受发布的影响，可以继续提交；
- 维护分支能快速打补丁，不影响正在开发的功能；
- 当生产中需要多个版本时，它是理想的选择。
**缺点**
- 需要频繁切换分支，较为繁琐；
- Git 历史记录变得不可读；
- 需要维护两个长期分支 master 和 develop；
- 不方便持续交付和持续发布。

## 三、Github Flow
> [Github Flow] 是 Git Flow 的简化版，专门配合"持续发布"。它是 Github.com 使用的工作流程。
(img)
它只有一个长期分支 master
(img)
1. 根据需求，从 master 分离新分支（不区分 feature 或 hotfix）。
2. 新分支开发完毕，或需要讨论时，向 master 分支发起 Pull Request。
3. Pull Request 既是一个通知，让别人注意到你的请求，又是一种对话机制，大家一起评审和讨论你的代码。对话过程中，你还可以不断提交代码。
4. 你的 Pull Request 被接受，合并进 master ，重新部署后，原来你拉出来的那个分支就被删除。（先部署再合并也可。）
**优点：**
- 用法简单，最适合“持续发布”和单个版本的产品；
- 可以减少工作中的冲突；
- 非常适合小型团队和 Web 应用程序。
**缺点：**
- 无法支撑多个版本的代码部署；
- 生产代码容易变得不稳定。

## 四、Gitlab Flow 工作流
> [Gitlab flow] 是 Git flow 与 Github flow 的综合。它吸取了两者的优点，既有适应不同开发环境的弹性，又有单一主分支的简单和便利。它是 Gitlab.com 推荐的做法。
**上游优先
Gitlab flow 的最大原则叫做“上游优先”（upsteam first），即只存在一个主分支 master ，它是所有其他分支的“上游”。只有 master 分支采纳的代码变化，才能应用到其他分支。
**Gitlab flow 分成两种情形来应付不同的开发流程**
### 持续发布
(img)
对于“持续发布”的项目，它建议在 master 分支以外再建立不同的环境分支，每个环境都有对应的分支。例如：
- 主干分支（master）：用于发布到测试环境，受保护的分支
- 预发分支（pre-production）：用于发布到预发环境，上游为 master
- 生产分支（production）：用于发布到正式环境，上游为 pre-production
**对于代码的变化，必须由“上游”向“下游”发展。**
比如 production 出现bug，需要进行如下操作：
1. 从 production 分离分支进行bug修复；
2. 修复完毕，合并到 master（即upsteam first）；
3. master 测试完毕，合并到 pre-production；
4. pre-production 也没有问题，才能够合并到 production。
**只有紧急情况，才允许跳过上游直接合并到下游分支**
### 版本发布
(img)
对于“版本发布”的项目，建议的做法是每一个稳定版本，都要从 master 分支拉出一个分支，比如`2-3-stable`、`2-4-stable`等。
版本发布后，只有bug修复（且依照上游优先）才允许将代码合并到这些分支，且需要更新小版本号。
**优点：**
- 集成“版本发布”和“持续发布”；
- Git 历史记录干净、易读。
**缺点：**
- 若需要在生产中维护多个版本时，它可能会变得比较复杂。
